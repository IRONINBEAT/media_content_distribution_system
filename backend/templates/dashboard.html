{% extends "base.html" %}

{% block content %}
<div class="card mb-5">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h4 class="mb-0">üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h4>
    </div>
    <div class="card-body">
        {% if devices %}
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</th>
                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for dev in devices %}
                <tr>
                    <td><code>{{ dev.device_id }}</code></td>
                    <td>{{ dev.description or "‚Äî" }}</td>
                    <td>
                        {% if dev.status == 'active' %}
                        <span class="badge bg-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                        {% elif dev.status == 'unverified' %}
                        <span class="badge bg-warning text-dark">–ñ–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</span>
                        {% else %}
                        <span class="badge bg-danger">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>
                        {% endif %}
                    </td>
                    <td>
                        <form method="post" action="/web/device/action" class="d-inline">
                            <input type="hidden" name="device_id" value="{{ dev.id }}">
                            {% if dev.status == 'unverified' or dev.status == 'blocked' %}
                            <button name="action" value="activate" class="btn btn-sm btn-success">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
                            {% endif %}
                            {% if dev.status == 'active' %}
                            <button name="action" value="block" class="btn btn-sm btn-warning">–ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                            {% endif %}
                            <button name="action" value="delete" class="btn btn-sm btn-danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ?');">–£–¥–∞–ª–∏—Ç—å</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-muted">–£—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h4 class="mb-0">üé¨ –í–∏–¥–µ–æ –∫–æ–Ω—Ç–µ–Ω—Ç</h4>
        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadModal">
            + –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ
        </button>
    </div>
    <div class="card-body">
        <div class="row">
            {% for file in files %}
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <video src="/web/stream/{{ file.file_id }}" class="card-img-top" controls style="height: 180px; object-fit: cover; background: #000;"></video>
                    <div class="card-body">
                        <h6 class="card-title text-truncate" title="{{ file.description }}">{{ file.description or "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è" }}</h6>
                        <small class="text-muted d-block mb-2">file_id: {{ file.file_id }}</small>
                        
                        <form method="post" action="/web/file/delete">
                            <input type="hidden" name="file_id" value="{{ file.file_id }}">
                            <button type="submit" class="btn btn-outline-danger btn-sm w-100" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª?');">–£–¥–∞–ª–∏—Ç—å</button>
                        </form>
                    </div>
                </div>
            </div>
            {% else %}
            <p class="text-muted">–§–∞–π–ª–æ–≤ –Ω–µ—Ç. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Ä–≤–æ–µ –≤–∏–¥–µ–æ.</p>
            {% endfor %}
        </div>
    </div>
</div>

<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <form method="post" action="/web/file/upload" enctype="multipart/form-data">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <input type="text" name="description" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–§–∞–π–ª (MP4)</label>
                        <input type="file" name="file" class="form-control" accept="video/mp4" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}